#!/bin/sh

. config/options

$SCRIPTS/checkdeps build
$SCRIPTS/checkdeps iso

export INSTALL=$BUILD/iso/GEEXBOX
rm -rf $BUILD/iso
$SCRIPTS/stage2 iso

rm -rf $BUILD/ziso
mkdir -p $BUILD/ziso
for d in etc PS3; do
  [ -d $BUILD/iso/$d ] && cp -PR $BUILD/iso/$d $BUILD/ziso/
done
mkzftree $INSTALL $BUILD/ziso/GEEXBOX

export INSTALL=$BUILD/ziso/GEEXBOX
$SCRIPTS/stage1 iso

case $TARGET_ARCH in
  i386|x86_64)
    MKISOFS_ARCH="-no-emul-boot \
                  -boot-info-table \
                  -boot-load-size 4 \
                  -b GEEXBOX/boot/isolinux.bin \
                  -c GEEXBOX/boot/boot.catalog"
    ;;
  powerpc|powerpc64)
    MKISOFS_ARCH="-hfs \
                  -part \
                  -no-desktop \
                  -map $CONFIG/maps \
                  -hfs-volid GEEXBOX \
                  -hfs-bless $BUILD/ziso/GEEXBOX/boot"
    ;;
esac

mkisofs -quiet -no-pad -V GEEXBOX -volset GEEXBOX \
        -publisher "The GeeXboX team (www.geexbox.org)" \
        -p "The GeeXboX team (www.geexbox.org)" \
        -A "MKISOFS ISO 9660/HFS FILESYSTEM BUILDER" \
        -z -D -r -J -sort $CONFIG/sort $MKISOFS_ARCH \
        $BUILD/ziso > $ISO

$BUILD/syslinux*/utils/isohybrid $ISO
