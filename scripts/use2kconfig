#!/bin/sh

. config/functions
. config/use

cat > config/Kconfig.use <<EOF
############################################
# This file is autogenerated, do not edit! #
############################################

EOF

flags=`grep PKG_USE_SECTION config/use | sed 's/^PKG_USE_SECTION_\([a-z0-9]*\)=.*$/\1/g' | xargs`

sections=`grep PKG_USE_SECTION_DESC config/use | sed 's/^PKG_USE_SECTION_DESC_\([a-z0-9]*\)=.*$/\1/g' | xargs`

for section in $sections; do
  cat >> config/Kconfig.use <<EOF
menu "`valueof PKG_USE_SECTION_DESC_${section}`"

EOF
  for use in $flags; do
    [ "`valueof PKG_USE_SECTION_${use}`" = "$section" ] || continue
    cat >> config/Kconfig.use <<EOF
config USE_${use}
  bool "`valueof PKG_USE_NAME_${use}`"
EOF
    archs="`valueof PKG_USE_ARCH_${use}`"
    if [ -n "$archs" ]; then
      archlist=""
      for arch in $archs; do
        [ -n "$archlist" ] && archlist="$archlist || "
        archlist="${archlist}TARGET_ARCH_${arch}"
      done
      echo "  depends on ( $archlist )" >> config/Kconfig.use
    fi
    pkgs="`valueof PKG_USE_DEPENDS_${use}`"
    if [ -n "$pkgs" ]; then
      for pkg in $pkgs; do
        echo "  select PKG_${pkg}" >> config/Kconfig.use
      done
    fi
    echo "  default n" >> config/Kconfig.use
    echo >> config/Kconfig.use
  done
  cat >> config/Kconfig.use <<EOF
endmenu

EOF
done
