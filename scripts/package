#!/bin/sh

. config/options

export PACKAGING=$1
export INSTALL="$PKGROOT/staging/$1"

rm -rf ${INSTALL}*
mkdir -p $INSTALL/CONTROL
touch $PKGROOT/staging/$1.deps

$SCRIPTS/pinstall $1

CONTROL=$INSTALL/CONTROL/control

if [ -r $PACKAGES/$1/package/control ]; then
  cp -P $PACKAGES/$1/package/* $INSTALL/CONTROL
else
  cat > $CONTROL <<EOF
Package: $1
Priority: optional
Section: Misc
Version: 0.0invalid
Description: $1 (autogenerated)
EOF
fi

if grep -v -E -q 'Depends:.*$' $CONTROL; then
  DEPENDS=""
  for d in `cat $PKGROOT/staging/$1.deps`; do
    [ -z "$DEPENDS" ] && DEPENDS="$d" || DEPENDS="$DEPENDS, $d"
  done
  [ -n "$DEPENDS" ] && echo "Depends: $DEPENDS" >> $CONTROL
fi

if grep -v -E -q '^Architecture:.*$' $CONTROL; then
  echo "Architecture: $TARGET_ARCH" >> $CONTROL
fi

echo "Maintainer: The GeeXboX Team (http://geexbox.org)" >> $CONTROL
echo "Source: http://hg.geexbox.org/geexbox" >> $CONTROL

opkg-build -c -O -o root -g root $INSTALL $PKGROOT

