#!/bin/sh
#
# setup tv cards
#
# runlevels: geexbox, debug, install

append_tv_option () {
  TV_OPTIONS="$TV_OPTIONS $1"
}

append_radio_option () {
  RADIO_OPTIONS="$RADIO_OPTIONS $1"
}

set_module_options () {
  OPT_FILE=/etc/modprobe.d/options

  # check if options file is not already set for this module
  grep "options $1" $OPT_FILE && return

  echo "options $1 $2" >> $OPT_FILE
}

echo "### Setting up TV card ###"

if ! grep -q -e '0400: 109e:' \
             -e '0480: 1131:' \
             -e ': 14f1:88' \
             -e '4444:0016' \
             -e '4444:0803' \
             /tmp/pci; then
  # No supported TV card found
  exit 1
fi

. /etc/tvcard
[ -f /etc/radio ] && . /etc/radio

test "$TV_CARD" != "AUTO" && append_tv_option "card=$TV_CARD"
test "$TV_TUNER" != "AUTO" && append_tv_option "tuner=$TV_TUNER"
test "$RADIO" = yes && append_radio_option "radio=1"

set_module_options bttv "$TV_OPTIONS $RADIO_OPTIONS"
set_module_options saa7134 "$TV_OPTIONS"
set_module_options cx88xx "$TV_OPTIONS"

echo "" > /var/tvcard

if grep -q -e '4444:0016' -e '4444:0803'  /tmp/pci; then
  echo '' > /var/use_pvr
fi

exit 0
