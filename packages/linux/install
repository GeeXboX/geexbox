#!/bin/sh

. config/options

VER=`ls $BUILD/$1*/modules/lib/modules`

case "$2" in
  image)
    test "$3" != installator && INSTALL="$INSTALL/boot"
    test "$3" = rootfs && INSTALL="$ROOTFS/boot"
    mkdir -p $INSTALL
    case $TARGET_ARCH in
      i386|x86_64)
        cp $BUILD/$1*/arch/$TARGET_ARCH/boot/bzImage $INSTALL/vmlinuz
        ;;
      powerpc)
        cp $BUILD/$1*/vmlinux $INSTALL/vmlinux
        $STRIP $INSTALL/vmlinux
        ;;
      powerpc64)
        cp $BUILD/$1*/arch/powerpc/boot/zImage $INSTALL/zImage
        $STRIP $INSTALL/zImage
        ;;
    esac
    ;;

  modules)
    $SCRIPTS/install module-init-tools $2

    # copy kernel drivers
    mkdir -p $INSTALL/lib/modules/$VER
    cp -r $BUILD/$1*/modules/* $INSTALL

    # copy kernel firmwares (if present)
    rm -rf $INSTALL/lib/firmware
    mkdir -p $INSTALL/firmware
    [ -d $BUILD/$1*/modules/lib/firmware ] && cp -rf $BUILD/$1*/modules/lib/firmware/* $INSTALL/firmware || echo "No firmware"
    ;;

  config)
    $SCRIPTS/install module-init-tools $2

    mkdir -p $INSTALL/sbin
    cp $PACKAGES/$1/scripts/setup_tvcard_options $INSTALL/sbin
    mkdir -p $INSTALL/etc
    cp $PACKAGES/$1/config/modules $INSTALL/etc
    cp $PACKAGES/$1/config/tvcard $INSTALL/etc
    cp $PACKAGES/$1/config/pvr $INSTALL/etc
    mkdir -p $INSTALL/etc/modprobe.d
    cp $PACKAGES/$1/config/tv.conf $INSTALL/etc/modprobe.d
    ;;
esac
