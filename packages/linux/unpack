#!/bin/sh

. config/options

$SCRIPTS/installdev make
$SCRIPTS/installdev sed

LINUX=`ls -d $ROOT/$BUILD/$1-2*`

case $TARGET_ARCH in
  i386|x86_64)
    TARGET_LINUX_ARCH=$TARGET_ARCH
    ;;
  powerpc|powerpc64)
    TARGET_LINUX_ARCH=powerpc
    ;;
  arm)
    TARGET_LINUX_ARCH=arm
    ;;
  *)
    TARGET_LINUX_ARCH=$TARGET_ARCH
    ;;
esac

KERNEL_CFG_FILE=$PACKAGES/$1/config/$1.$TARGET_ARCH.conf
[ -f $PACKAGES/$1/config/$1.$TARGET_PLATFORM.conf ] && KERNEL_CFG_FILE=$PACKAGES/$1/config/$1.$TARGET_PLATFORM.conf
[ -n "$CUSTOM_KERNEL_CFG_FILE" ] && KERNEL_CFG_FILE=$CUSTOM_KERNEL_CFG_FILE

sed -i -e "s|^HOSTCC[[:space:]]*=.*$|HOSTCC = $HOST_CC|" \
       -e "s|^HOSTCXX[[:space:]]*=.*$|HOSTCXX = $HOST_CXX|" \
       -e "s|^ARCH[[:space:]]*?=.*$|ARCH = $TARGET_LINUX_ARCH|" \
       -e "s|^CROSS_COMPILE[[:space:]]*?=.*$|CROSS_COMPILE = $TARGET_PREFIX|" \
       $LINUX/Makefile

cp $KERNEL_CFG_FILE $LINUX/.config

make -C $LINUX oldconfig
make -C $LINUX prepare1
