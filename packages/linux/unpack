#!/bin/sh

. config/options

$SCRIPTS/install make
$SCRIPTS/install sed toolchain
$SCRIPTS/unpack lzma

LINUX=`ls -d $BUILD/$1*`

case $TARGET_ARCH in
  i386|x86_64)
    mkdir -p $LINUX/include/asm-x86
    cp -r $LINUX/arch/x86/include/asm/* $LINUX/include/asm-x86
    TARGET_LINUX_ARCH=$TARGET_ARCH
    ;;
  powerpc|powerpc64)
    TARGET_LINUX_ARCH=powerpc
    mkdir -p $LINUX/include/asm-powerpc
    cp -r $LINUX/arch/powerpc/include/asm/* $LINUX/include/asm-powerpc
    ;;
  *)
    TARGET_LINUX_ARCH=$TARGET_ARCH
    ;;
esac

KERNEL_CFG_FILE=$PACKAGES/$1/config/$1.$TARGET_ARCH.conf
[ -f $PACKAGES/$1/config/$1.$TARGET_PLATFORM.conf ] && KERNEL_CFG_FILE=$PACKAGES/$1/config/$1.$TARGET_PLATFORM.conf
[ -n "$CUSTOM_KERNEL_CFG_FILE" ] && KERNEL_CFG_FILE=$CUSTOM_KERNEL_CFG_FILE

sed -i -e "s|^HOSTCC[[:space:]]*=.*$|HOSTCC = $HOST_CC|" \
       -e "s|^HOSTCXX[[:space:]]*=.*$|HOSTCXX = $HOST_CXX|" \
       -e "s|^ARCH[[:space:]]*?=.*$|ARCH = $TARGET_LINUX_ARCH|" \
       -e "s|^CROSS_COMPILE[[:space:]]*?=.*$|CROSS_COMPILE = $TARGET_PREFIX|" \
       $LINUX/Makefile

cp $KERNEL_CFG_FILE $LINUX/.config
if [ "$DEVTOOLS" = yes ]; then
  echo "CONFIG_KALLSYMS=y" >> $LINUX/.config
  echo "CONFIG_KALLSYMS_EXTRA_PASS=y" >> $LINUX/.config
  echo "# CONFIG_KPROBES is not set" >> $LINUX/.config
fi

LZMA_DIR="$ROOT/`ls -d $BUILD/lzma*`/C/Compress/Lzma"
for i in LzmaDecode.c LzmaDecode.h LzmaTypes.h; do
  # needed by 20_lzma-vmlinux.diff
  ln -s "$LZMA_DIR/$i" $LINUX/arch/*86/boot/compressed/
  # needed by 21_lzma-initrd.diff
  ln -s "$LZMA_DIR/$i" $LINUX/init/
done

make -C $LINUX oldconfig
make -C $LINUX prepare1
