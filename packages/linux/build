#!/bin/sh

. config/options

$SCRIPTS/build toolchain
$SCRIPTS/build module-init-tools
[ "$TARGET_ARCH" = "arm" ] && $SCRIPTS/build uboot-mkimage

unset LDFLAGS
DEPMOD="$ROOT/$TOOLCHAIN/bin/depmod"

cd $(kernel_path)
rm -rf modules
mkdir -p modules

case $TARGET_ARCH in
  i386|x86_64)  IMAGE=bzImage  ;;
  powerpc)      IMAGE=vmlinux  ;;
  powerpc64)    IMAGE=zImage   ;;
  arm)          IMAGE=uImage   ;;
esac
make $IMAGE
make modules
make INSTALL_MOD_PATH=modules DEPMOD=$DEPMOD modules_install
rm -f modules/lib/modules/*/build
rm -f modules/lib/modules/*/source
