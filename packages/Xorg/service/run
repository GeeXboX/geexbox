#!/bin/sh
#
# configure X.Org video settings
#
# runlevels: geexbox

. /etc/funcs

[ -f /var/data/config/xorg.conf ] && make_persistent file /etc/X11/xorg.conf /var/data/config/xorg.conf

# tty used for the video display
TTY=4

# don't start Xorg in debug mode
grep "debug" /proc/cmdline > /dev/null && [ "$1" != "force" ] && exit 1

# don't start Xorg in installator mode
grep "installator" /proc/cmdline > /dev/null && [ "$1" != "force" ] && exit 1

[ -f /usr/bin/Xorg -a -f /var/use_xorg ] || exit 1
echo "### Configuring X.Org video settings ###"

# Fix the /etc/X11 case-insensitive fs directory creation issue
[ -d /etc/x11 ] && ln -s /etc/x11 /etc/X11

echo "### Starting X.Org ###"

# use Screen0 if present to workaround a bug with some graphic drivers
# that report 2 screens and prevent Xorg from loading correctly
SCREEN=
[ -f /etc/X11/xorg.conf ] && grep -q Screen0 /etc/X11/xorg.conf && SCREEN="-screen Screen0"
# starts X.org with a black background
exec Xorg vt$TTY -s 0 -dpms -br -noreset -allowMouseOpenFail $SCREEN > /dev/null 2>&1

