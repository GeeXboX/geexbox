#!/bin/sh

. config/options

$SCRIPTS/build linux
$SCRIPTS/build toolchain
$SCRIPTS/build lzo
$SCRIPTS/build freetype

export CFLAGS="$CFLAGS -O2"
HEADERS="`kernel_path`/arch/x86/include"
COMMAND_LINE_SIZE=`cat ${HEADERS}/asm/setup.h | grep "^#define COMMAND_LINE_SIZE" | cut -d\  -f3`
export TARGET_CPPFLAGS="-DCOMMAND_LINE_SIZE=${COMMAND_LINE_SIZE} ${TARGET_CPPFLAGS}"

cd $BUILD/$1*
export ac_cv_prog_FREETYPE=$LIB_PREFIX/bin/freetype-config
#export PATH=$PATH:$LIB_PREFIX/lib/pkgconfig
./configure --host=$TARGET_NAME \
            --build=$HOST_NAME \
            --prefix="/usr/" \
            --enable-grub-mkfont \

make || exit 1

BIN_FILES="grub-mkimage grub-mkelfimage grub-editenv grub-mkrescue"
SBIN_FILES="grub-install grub-mkconfig grub-dumpbios grub-mkdevicemap grub-probe grub-setup"
LIB_GRUB_FILES="grub-mkconfig_lib update-grub_lib"
LIB_GRUB_ARCH_FILES="acorn.mod acpi.mod affs.mod afs.mod amiga.mod aout.mod apple.mod at_keyboard.mod ata.mod ata_pthru.mod biosdisk.mod bitmap.mod blocklist.mod boot.img boot.mod bsd.mod bufio.mod build_env.mk cat.mod cdboot.img chain.mod cmp.mod command.lst config.h configfile.mod cpio.mod cpuid.mod crc.mod date.mod datehook.mod datetime.mod diskboot.img dm_nv.mod drivemap.mod echo.mod efiemu.mod elf.mod ext2.mod extcmd.mod fat.mod font.mod fs.lst fs_file.mod fs_uuid.mod fshelp.mod gfxterm.mod gpt.mod gptsync.mod grub_script.tab.h gzio.mod halt.mod handler.lst handler.mod hdparm.mod hello.mod help.mod hexdump.mod hfs.mod hfsplus.mod iso9660.mod jfs.mod jpeg.mod kernel.img linux.mod linux16.mod lnxboot.img loadenv.mod loopback.mod ls.mod lsmmap.mod lspci.mod lua.mod lvm.mod mdraid.mod memdisk.mod memrw.mod minicmd.mod minix.mod mmap.mod moddep.lst multiboot.mod normal.mod ntfs.mod ntfscomp.mod ohci.mod partmap.lst parttool.lst parttool.mod pc.mod pci.mod pcpart.mod play.mod png.mod probe.mod pxe.mod pxeboot.img pxecmd.mod raid.mod raid5rec.mod raid6rec.mod read.mod reboot.mod reiserfs.mod scsi.mod search.mod serial.mod setjmp.mod sfs.mod sh.mod sleep.mod sun.mod tar.mod terminfo.mod test.mod tga.mod true.mod udf.mod ufs1.mod ufs2.mod uhci.mod usb.mod usb_keyboard.mod usbms.mod usbtest.mod vbe.mod vbeinfo.mod vbetest.mod vga.mod vga_text.mod video.mod video_fb.mod videotest.mod xfs.mod xnu.mod xnu_uuid.mod"

( mkdir -p __build/bin __build/sbin __build/lib/grub/i386-pc && \
cp $BIN_FILES __build/bin/ && \
cp $SBIN_FILES __build/sbin/ && \
cp $LIB_GRUB_FILES __build/lib/grub/ && \
cp $LIB_GRUB_ARCH_FILES __build/lib/grub/i386-pc/ ) || \
exit 1

( [ -f ../font-misc-misc*/8x13.bdf ] && mkdir -p __build/lib/grub/fonts && ./grub-mkfont -o __build/lib/grub/fonts/8x13.pf2 ../font-misc-misc*/8x13.bdf ) || true

