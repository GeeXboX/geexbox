#!/bin/sh

. config/options

$SCRIPTS/build toolchain
$SCRIPTS/build lzo

export CFLAGS="$CFLAGS -O2"

cd $BUILD/$1*
./configure --host=$TARGET_NAME \
            --build=$HOST_NAME \
            --prefix="/usr" \
            --disable-shared \
            --without-curses \

#FIXME: dirty workaround, but only every second build runs through, dunno why till now
make || make

BIN_FILES="grub-mkimage grub-mkrescue"
SBIN_FILES="grub-install grub-mkdevicemap grub-probe grub-setup update-grub"
LIB_GRUB_FILES="update-grub_lib"
LIB_GRUB_ARCH_FILES="acorn.mod affs.mod amiga.mod apple.mod ata.mod biosdisk.mod bitmap.mod blocklist.mod boot.img boot.mod cat.mod cdboot.img _chain.mod chain.mod cmp.mod command.lst configfile.mod cpio.mod cpuid.mod diskboot.img echo.mod elf.mod ext2.mod fat.mod font.mod fshelp.mod fs.lst gfxterm.mod gpt.mod gzio.mod halt.mod hello.mod help.mod hexdump.mod hfs.mod hfsplus.mod iso9660.mod jfs.mod jpeg.mod kernel.img _linux.mod linux.mod lnxboot.img loopback.mod ls.mod lspci.mod lvm.mod memdisk.mod minix.mod moddep.lst _multiboot.mod multiboot.mod normal.mod ntfscomp.mod ntfs.mod pci.mod pc.mod play.mod png.mod pxeboot.img raid.mod read.mod reboot.mod reiserfs.mod search.mod serial.mod sfs.mod sun.mod terminal.mod terminfo.mod test.mod tga.mod ufs.mod update-grub_lib vbeinfo.mod vbe.mod vbetest.mod vga.mod video.mod videotest.mod xfs.mod"

mkdir -p build/bin build/sbin build/lib/grub/i386-pc
for f in $BIN_FILES; do cp $f build/bin; done
for f in $SBIN_FILES; do cp $f build/sbin; done
for f in $LIB_GRUB_FILES; do cp $f build/lib/grub; done
for f in $LIB_GRUB_ARCH_FILES; do cp $f build/lib/grub/i386-pc; done
