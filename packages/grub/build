#!/bin/sh

. config/options

$SCRIPTS/build linux
$SCRIPTS/build toolchain
$SCRIPTS/build lzo
$SCRIPTS/build freetype

export CFLAGS="$CFLAGS -O2"
HEADERS="`kernel_path`/arch/x86/include"
COMMAND_LINE_SIZE=`cat ${HEADERS}/asm/setup.h | grep "^#define COMMAND_LINE_SIZE" | cut -d\  -f3`
export TARGET_CPPFLAGS="-DCOMMAND_LINE_SIZE=${COMMAND_LINE_SIZE} ${TARGET_CPPFLAGS}"

cd $BUILD/$1*
export ac_cv_prog_FREETYPE=$LIB_PREFIX/bin/freetype-config
#export PATH=$PATH:$LIB_PREFIX/lib/pkgconfig
./configure --host=$TARGET_NAME \
            --build=$HOST_NAME \
            --prefix="/usr/" \
            --enable-grub-mkfont \

make || exit 1

BIN_FILES="grub-mkimage grub-mkelfimage grub-editenv grub-mkrescue"
SBIN_FILES="grub-install grub-mkconfig grub-dumpbios grub-mkdevicemap grub-probe grub-setup"
LIB_GRUB_FILES="grub-mkconfig_lib update-grub_lib"
LIB_GRUB_ARCH_FILES="acpi.mod affs.mod afs.mod afs_be.mod aout.mod at_keyboard.mod ata.mod ata_pthru.mod befs.mod befs_be.mod biosdisk.mod bitmap.mod blocklist.mod boot.mod bsd.mod bufio.mod cat.mod chain.mod cmp.mod configfile.mod cpio.mod cpuid.mod crc.mod date.mod datehook.mod datetime.mod dm_nv.mod drivemap.mod echo.mod efiemu.mod elf.mod ext2.mod extcmd.mod fat.mod font.mod fs_file.mod fs_uuid.mod fshelp.mod gfxterm.mod gptsync.mod gzio.mod halt.mod handler.mod hdparm.mod hello.mod help.mod hexdump.mod hfs.mod hfsplus.mod iso9660.mod jfs.mod jpeg.mod keystatus.mod linux.mod linux16.mod loadenv.mod loopback.mod ls.mod lsmmap.mod lspci.mod lvm.mod mdraid.mod memdisk.mod memrw.mod minicmd.mod minix.mod mmap.mod msdospart.mod multiboot.mod normal.mod ntfs.mod ntfscomp.mod ohci.mod part_acorn.mod part_amiga.mod part_apple.mod part_gpt.mod part_msdos.mod part_sun.mod parttool.mod password.mod pci.mod play.mod png.mod probe.mod pxe.mod pxecmd.mod raid.mod raid5rec.mod raid6rec.mod read.mod reboot.mod reiserfs.mod scsi.mod search.mod serial.mod setjmp.mod sfs.mod sh.mod sleep.mod tar.mod terminfo.mod test.mod tga.mod true.mod udf.mod ufs1.mod ufs2.mod uhci.mod usb.mod usb_keyboard.mod usbms.mod usbtest.mod vbe.mod vbeinfo.mod vbetest.mod vga.mod vga_text.mod video.mod video_fb.mod videotest.mod xfs.mod xnu.mod xnu_uuid.mod"

( mkdir -p __build/bin __build/sbin __build/lib/grub/i386-pc && \
cp $BIN_FILES __build/bin/ && \
cp $SBIN_FILES __build/sbin/ && \
cp $LIB_GRUB_FILES __build/lib/grub/ && \
cp $LIB_GRUB_ARCH_FILES __build/lib/grub/i386-pc/ ) || \
exit 1

( [ -f ../font-misc-misc*/8x13.bdf ] && mkdir -p __build/lib/grub/fonts && ./grub-mkfont -o __build/lib/grub/fonts/8x13.pf2 ../font-misc-misc*/8x13.bdf ) || true

