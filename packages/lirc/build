#!/bin/sh

. config/options

$SCRIPTS/build linux

if [ "$DEBUG" = yes ]; then
  DEBUG_CONFIG="--enable-debug --disable-stripping"
else
  DEBUG_CONFIG="--disable-debug --enable-stripping"
fi

export ac_cv_path_LIBUSB_CONFIG=
export ac_cv_func_forkpty=no
export ac_cv_lib_util_forkpty=no
export ac_cv_header_scsi_sg_h=no
export LDFLAGS="$LDFLAGS -lusb"
export MAKEFLAGS=-j1

cd $BUILD/$1-[0-9]*
do_configure \
            --without-x \
            --with-driver=all \
            --with-port=0x3f8 \
            --with-irq=4 \
            --with-kerneldir=$(kernel_path) \
            $DEBUG_CONFIG

# Can not be built (tested against linux-2.6.33.5)
[ $TARGET_ARCH = arm ] && sed -i 's,lirc_wpc8769l,,g' drivers/Makefile

make
install_dir="$PWD/.install"
mkdir -p "$install_dir"
make -C daemons install DESTDIR="$install_dir"
make -C tools install DESTDIR="$install_dir"
fix_libs "$install_dir"
