#! /bin/sh

PLATFORM=$(grep -o "i.MX6\|BCM[0-9]*" /proc/cpuinfo)

case "$PLATFORM" in
  "i.MX6")
       MMCDEV="mmc1 mmc0"; TTY="/dev/ttymxc3"; RATE="3000000"
       ;;
  "BCM2709")
       if grep -q "=ttyAMA0" /proc/cmdline; then
         MMCDEV="mmc1"; TTY="/dev/ttyS0"; RATE="115200"
       else
         MMCDEV="mmc1"; TTY="/dev/ttyAMA0"; RATE="921600"
       fi
       ;;
  *) echo "Unsupported platform.";;
esac

if [ -e "$TTY" ]; then
  for mmc in $MMCDEV; do
    CHIP_ID=$(cat /sys/class/mmc_host/$mmc/$mmc\:0001/$mmc\:0001\:1/device 2>/dev/null)
    [ -n "$CHIP_ID" ] && break;
  done

  case "$CHIP_ID" in
    "0x4329") MODE="bcm4329 $RATE flow";;
    "0x4330") MODE="bcm43xx $RATE flow";;
    "0xa9a6") MODE="bcm43xx-3wire $RATE noflow";;
          "") echo "No device found."; exit 0;;
           *) echo "Unknown device: $CHIP_ID"; exit 1;;
  esac

  echo "Found chip version $CHIP_ID."
  hciattach $TTY $MODE -
fi

exit 0
