#!/bin/sh

. config/options

require_glibc $1

[ "$VDPAU" = yes -a "$DEVTOOLS" = yes -a "$TOOLCHAIN_CXX" = yes ] && \
  $SCRIPTS/install vdpinfo

XORG_DST="$INSTALL/$XORG_PATH_MODULES"

# nVidia kernel driver
mkdir -p "`ls -d $INSTALL/lib/modules/*`/kernel/drivers/video"
cp $BUILD/$1/usr/src/nv/nvidia.ko $INSTALL/lib/modules/*/kernel/drivers/video

# X.Org driver
mkdir -p $XORG_DST/drivers
cp $BUILD/$1/usr/X11R6/lib/modules/drivers/*_drv.so $XORG_DST/drivers

# System Libs
cp $BUILD/$1/usr/lib/tls/*tls*.so* $INSTALL/usr/lib/libnvidia-tls.so.1

# OpenGL libs
if [ "$OPENGL" = yes ]; then
  cp $BUILD/$1/usr/lib/libGLcore.so* $INSTALL/usr/lib/libGLcore.so.1
  cp $BUILD/$1/usr/lib/libGL.so* $INSTALL/usr/lib/libGL.so.1
  mkdir -p $XORG_DST/extensions
  cp $BUILD/$1/usr/X11R6/lib/modules/extensions/libglx.so* \
    $XORG_DST/extensions/libglx.so
fi

# VDPAU libs
if [ "$VDPAU" = yes ]; then
  for vdpaulib in vdpau_nvidia vdpau vdpau_trace; do
    cp $BUILD/$1/usr/lib/lib${vdpaulib}.so* \
      $INSTALL/usr/lib/lib${vdpaulib}.so.1
    ln -s lib${vdpaulib}.so.1 $INSTALL/usr/lib/lib${vdpaulib}.so
  done
  cat >> $INSTALL/etc/video <<EOF
# Enable VDPAU accelerated video decoding
# requires a supported nVidia card and nvidia driver
VDPAU=yes
EOF
fi

exit 0
