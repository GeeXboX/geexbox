#!/bin/sh

. config/options

require_glibc $1

[ "$VDPAU" = yes -a "$DEVTOOLS" = yes ] && $SCRIPTS/install vdpauinfo

XORG_DST="$INSTALL/$XORG_PATH_MODULES"

# nVidia kernel driver
mkdir -p "`ls -d $INSTALL/lib/modules/*`/kernel/drivers/video"
cp $BUILD/$1/usr/src/nv/nvidia.ko $INSTALL/lib/modules/*/kernel/drivers/video

# X.Org driver
mkdir -p $XORG_DST/drivers
cp $BUILD/$1/usr/X11R6/lib/modules/drivers/*_drv.so $XORG_DST/drivers

# System Libs
cp $BUILD/$1/usr/lib/tls/*tls*.so* $INSTALL/usr/lib/libnvidia-tls.so.1

# OpenGL libs
cp $BUILD/$1/usr/lib/libGLcore.so* $INSTALL/usr/lib/libGLcore.so.1
mkdir -p $INSTALL/usr/lib/nvidia
cp $BUILD/$1/usr/lib/libGL.so* $INSTALL/usr/lib/nvidia/libGL.so.1
cp $BUILD/$1/usr/X11R6/lib/modules/extensions/libglx.so* \
    $INSTALL/usr/lib/nvidia/libglx.so

cat >> $INSTALL/etc/video <<EOF
# Enable Xorg non-free binary drivers
BINARY_DRIVERS=yes
EOF

# VDPAU libs
if [ "$VDPAU" = yes ]; then
  cp $BUILD/$1/usr/lib/vdpau/libvdpau_nvidia.so* \
      $INSTALL/usr/lib/libvdpau_nvidia.so.1
  ln -s libvdpau_nvidia.so.1 $INSTALL/usr/lib/libvdpau_nvidia.so
  cat >> $INSTALL/etc/video <<EOF
# Enable VDPAU accelerated video decoding
# requires a supported nVidia card and nvidia driver
VDPAU=yes
EOF
fi

exit 0
