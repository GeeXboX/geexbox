#!/bin/sh

. config/options

$SCRIPTS/build toolchain
$SCRIPTS/build gettext
$SCRIPTS/build pciutils
$SCRIPTS/build udev
$SCRIPTS/build expat
$SCRIPTS/build GLib
$SCRIPTS/build dbus
$SCRIPTS/build dbus-glib

export CFLAGS="$CFLAGS -I$LIB_PREFIX/include"
export LDFLAGS="$LDFLAGS -L$LIB_PREFIX/lib"

cd $BUILD/$1*

./configure --host=$TARGET_NAME \
            --build=$HOST_NAME \
            --prefix=$LIB_PREFIX \
            --exec-prefix=/usr \
            --sysconfdir=/etc \
            --datadir=/usr/share \
            --localstatedir=/var \
            --disable-static \
            --enable-shared \
            --disable-docbook-docs \
            --disable-man-pages \
            --disable-gtk-doc \
            --enable-largefile \
            --enable-pci \
            --enable-pci-ids \
            --with-libpci \
            --enable-usb \
            --enable-usb-ids \
            --enable-pnp-ids \
            --disable-apm \
            --disable-pmu \
            --disable-acpi \
            --disable-acpi-acpid \
            --disable-acpi-proc \
            --disable-acpi-ibm \
            --disable-acpi-toshiba \
            --disable-parted \
            --disable-smbios \
            --disable-console-kit \
            --disable-policy-kit \
            --disable-acl-management \
            --disable-umount-helper \
            --disable-sonypic \
            --with-pid-file=/var/run/hald/hald.pid \
            --with-pci-ids=/usr/share \
            --with-usb-ids=/usr/share \
            --with-socket-dir=/var/run/dbus \
            --with-hal-user=root \
            --with-hal-group=root \
            --with-backend=linux \
            --with-keymaps \
            --with-deprecated-keys \
            --with-dbus-sys=/etc/dbus-1 \
            --without-macbookpro \
            --without-macbook \
            --without-imac \
            --without-omap \
            --without-cpufreq \
            --without-usb-csr \
            --without-dell-backlight \

make
$STRIP libhal/.libs/libhal.so*
$STRIP libhal-storage/.libs/libhal-storage.so*
make -C libhal install libdir=$LIB_PREFIX/lib
sed -i "s%libdir=.*%libdir='$LIB_PREFIX/lib'%" $LIB_PREFIX/lib/libhal.la
sed -i 's%libdir=.*%libdir=${prefix}/lib%' hal.pc
make install-pkgconfigDATA libdir=$LIB_PREFIX/lib

# hal-storage
cp -PR libhal-storage/.libs/libhal-storage.so* $LIB_PREFIX/lib
cp -PR libhal-storage/libhal-storage.la $LIB_PREFIX/lib
sed -i "s%libdir=.*%libdir='$LIB_PREFIX/lib'%" $LIB_PREFIX/lib/libhal.la
sed -i 's%libdir=.*%libdir=${prefix}/lib%' hal.pc
cp hal.pc $LIB_PREFIX/lib/pkgconfig/
