#!/bin/sh

DONE=0

setup_tvscan () {
  local MPTV="mplayer tv:// -really-quiet -msglevel tv=4 -ao null -vo null"
  local title="$MSG_TV_CONFIG"
  local input inputs norm norms chanlist chanlists channels_mplayer_param
  local channels

  # Is a TV card actually present ?
  if [ ! -f /var/tvcard ]; then
    dialog --aspect 15 --backtitle "$MSG_CFG_TITLE" --title "$MSG_ERROR" \
      --msgbox "$MSG_TV_NO_CARD" 0 0
    return;
  fi

  # Configure TV card and scan for channels ?
  dialog --aspect 15 --backtitle "$BACKTITLE" --title "$MSG_CFG_TV" \
    --yesno "$MSG_CFG_TV_DESC" 0 0 || return

  inputs=`$MPTV -frames 0 2>/dev/null | grep "inputs:" | \
    sed -e 's/ inputs: //' -e 's/= //g' -e 's/;//g'`

  norms=`$MPTV -frames 0 2>/dev/null | grep "supported norms:" | \
    sed -e 's/ supported norms: //' -e 's/= //g' -e 's/;//g'`

  chanlists="us-bcast '' us-cable '' us-cable-hrc '' japan-bcast '' japan-cable '' europe-west '' europe-east '' italy '' newzealand '' australia '' ireland '' france '' china-bcast '' southafrica '' argentina '' russia ''"

  while [ -z "$TV_DONE" ]; do
    input=`dialog --no-cancel --aspect 15 --stdout --backtitle "$title" \
      --title "$MSG_TV_INPUT" --menu "$MSG_TV_INPUT_DESC" 0 0 0 $inputs`

    norm=`dialog --no-cancel --aspect 15 --stdout --backtitle "$title" \
      --title "$MSG_TV_NORM" --menu "$MSG_TV_NORM_DESC" 0 0 0 $norms`

    chanlist=`dialog --no-cancel --aspect 15 --stdout --backtitle "$title" \
      --title "$MSG_TV_CHANLIST" \
      --menu "$MSG_TV_CHANLIST_DESC" 0 0 0 $chanlists`

    channels_mplayer_param=`$MPTV -tvscan autostart -frames 600 \
      -tv driver=v4l2:input=$input:norm=$norm:chanlist=$chanlist 2>/dev/null |\
      grep "^channels="`  | dialog --no-cancel --aspect 15 --stdout \
      --backtitle "$title" --title "$MSG_TV_SCAN" --gauge "$MSG_TV_SCAN_DESC" \
      0 0

    channels=`echo $channels_mplayer_param | sed -e 's/channels=//g' \
      -e 's/-/ - /g' -e 's/,/\\\\n/g' -e 's/$/\\\\n/g'`

    dialog --aspect 12 --stdout --yes-label "$MSG_TV_ACCEPT" \
      --no-label "MSG_TV_RETRY" --backtitle "$title" \
      --title "$MSG_TV_SCAN_DONE" \
      --yesno "\n${MSG_TV_SCAN_DONE_DESC}\n\n$channels" 0 0 && TV_DONE=true
  done

  [ `echo $channels_mplayer_param | grep -c "channels="` -eq 1 ] && \
    echo "tv=$channels_mplayer_param" >> /etc/mplayer/mplayer.conf

  sed -i --follow-symlinks "s/^TVIN_STANDARD=.*/TVIN_STANDARD=$norm/" /etc/tvcard
  sed -i --follow-symlinks "s/^CHANLIST=.*/CHANLIST=$chanlist/" /etc/tvcard
}

dvb_do_scan() {
  local CHANNELS_CONF="/etc/mplayer/channels.conf"

  # Scan FreeToAir channels only
  dvbscan -x 0 "$1" > $CHANNELS_CONF 2> /dev/null

  if [ -s $CHANNELS_CONF ]; then
    # remove non-coherent detected channels
    grep -v "^\[.*\]:" $CHANNELS_CONF > /tmp/channels.conf
    mv /tmp/channels.conf $CHANNELS_CONF
  fi
}

setup_dvbscan () {
  local DVB_LIST=/usr/share/dvb
  local TITLE="$MSG_DVB_CONFIG"
  local i dvb_type countries country cities city sats sat atsc freq

  # Is a TV card actually present ?
  if [ ! -f /var/dvbcard ]; then
    dialog --aspect 15 --backtitle "$MSG_CFG_TITLE" --title "$MSG_ERROR" \
      --msgbox "$MSG_DVB_NO_CARD" 0 0
    return;
  fi

  # Configure DVB card and scan for channels ?
  dialog --aspect 15 --backtitle "$BACKTITLE" --title "$MSG_CFG_DVB" \
    --yesno "$MSG_CFG_DVB_DESC" 0 0 || return

  [ -f /usr/share/dvb.tar.lzma -a ! -d $DVB_LIST ] && \
    tar xaf /usr/share/dvb.tar.lzma -C /usr/share

  dvb_type=`dialog --no-cancel --aspect 15 --stdout --backtitle "$TITLE" \
    --title "$MSG_DVB_TYPE" --menu "$MSG_DVB_TYPE_DESC" 0 0 0 dvb-s \
    "$MSG_DVB_SAT" dvb-t "$MSG_DVB_TER" dvb-c "$MSG_DVB_CABLE" atsc \
    "$MSG_DVB_ATSC"`

  # DVB Terrestrial cards
  if [ $dvb_type = "dvb-t" -o $dvb_type = "dvb-c" ]; then
    for i in `ls $DVB_LIST/$dvb_type`; do
      countries="$countries $i ''"
    done

    country=`dialog --no-cancel --aspect 15 --stdout --backtitle "$TITLE" \
      --title "$MSG_DVB_COUNTRY" --menu "$MSG_DVB_COUNTRY_DESC" 0 0 0 \
      $countries`

    for i in `ls $DVB_LIST/$dvb_type/$country`; do
      cities="$cities $i ''"
    done

    city=`dialog --no-cancel --aspect 15 --stdout --backtitle "$TITLE" \
      --title "$MSG_DVB_CITY" --menu "$MSG_DVB_CITY_DESC" 0 0 0 $cities`

    dvb_do_scan "$DVB_LIST/$dvb_type/$country/$city"
  elif [ $dvb_type = "dvb-s" ]; then
    for i in `ls $DVB_LIST/$dvb_type`; do
      sats="$sats $i ''"
    done

    sat=`dialog --no-cancel --aspect 15 --stdout --backtitle "$TITLE" \
      --title "$MSG_DVB_SAT_SEL" --menu "$MSG_DVB_SAT_SEL_DESC" 0 0 0 $sats`

    dvb_do_scan "$DVB_LIST/$dvb_type/$sat"
  elif [ $dvb_type = "atsc" ]; then
    for i in `ls $DVB_LIST/$dvb_type`; do
      atsc="$atsc $i ''"
    done

    freq=`dialog --no-cancel --aspect 15 --stdout --backtitle "$TITLE" \
      --title "$MSG_DVB_ATSC_SEL" --menu "$MSG_DVB_ATSC_SEL_DESC" 0 0 0 $atsc`

    dvb_do_scan "$DVB_LIST/$dvb_type/$freq"
  fi
}

tv_menu () {
  local menu=`dialog --no-cancel --aspect 15 --stdout \
    --backtitle "$MSG_CFG_TITLE" --title "$MSG_MENU_TV" \
    --menu "$MSG_TV_DESC" 0 0 0 tv  "$MSG_TV_MENU_ANALOG ..." \
    dvb "$MSG_TV_MENU_DVB ..." "" "" quit "$MSG_RETURN ..."`

  case $menu in
    tv)
      setup_tvscan
      ;;
    dvb)
      setup_dvbscan
      ;;
    quit)
      DONE=1
      ;;
  esac
}

# include configurator common file
. /usr/share/configurator/common

# get i18n strings
get_i18n

while [ $DONE != 1 ]; do
  tv_menu
done
