#!/bin/sh

get_device () {
  local dev=`mount | grep "$1" | sed 's/\(.*\) on.*/\1/'`
  # Debugging
  echo "\"get_device $@\" returned: $dev" >> $LOGFILE
  echo $dev
}

remount () {
  mount -o remount,$1 "$2" "$3"
}

copy_cfg_file () {
  local src="$1"
  local mount_point="$2"
  if [ -d "${mount_point}/GEEXBOX" ]; then
    local dest="${mount_point}/GEEXBOX/$3"
  else
    # TODO: should be possible to also save to a different location
    local dest="${mount_point}/geexbox-data/$3"
    mkdir -p "$dest"
  fi
  echo "\"copy_cfg_file $@\" called" >> $LOGFILE
 
  if [ -f "$src" ]; then
    echo "Copying $src to $dest" 2>&1 >> $LOGFILE
    # Actual command
    cp "$src" "$dest"
  fi
}

update_boot () {
  local mount_point_grub="$1/boot/grub"
  local mount_point_sysl="$1"
  local item="$2"
  local value="$3"
  local file

  echo "\"update_boot $@\" called" >> $LOGFILE

  # don't try to set an item with a non-existing value
  test -z "$value" && return;

  for file in "$mount_point_grub/grub.cfg" \
              "$mount_point_sysl/syslinux.cfg"; do
    # Don't try to change a non-existant file
    [ ! -f "$file" ] && continue

    echo "Editing \"$file\" with $2=$3" >> $LOGFILE
    echo "Before edit:" >> $LOGFILE
    cat "$file" >> $LOGFILE

    # Actual command
    sed -i "s/$2=[^ ]*/$2=$3/g" "$file"

    echo "After edit:" >> $LOGFILE
    cat "$file" >> $LOGFILE
  done
}

save_configs () {
  # data share
  [ -n "$data_uuid" ] && update_boot "$geex_partition" "data" "UUID=${data_uuid}"
  # lang settings
  update_boot "$geex_partition" keymap "$CFG_KEYMAP"
  update_boot "$geex_partition" lang "$CFG_LANG"

  # time settings
  copy_cfg_file /etc/adjtime "$data_partition" /etc

  # video settings
  update_boot "$geex_partition" vga "$CFG_VESA_MODE"
  copy_cfg_file /etc/X11/X.cfg "$data_partition" /etc/X11
  copy_cfg_file /etc/X11/xorg.conf "$data_partition" /etc/X11

  # network settings
  copy_cfg_file /etc/network "$data_data_partition" /etc

  # tv settings
  copy_cfg_file /etc/mplayer/mplayer.conf "$data_partition" /etc/mplayer
  copy_cfg_file /etc/mplayer/channels.conf "$data_partition" /etc/mplayer
  copy_cfg_file /etc/vdr/channels.conf "$data_partition" /etc/vdr
  copy_cfg_file /etc/tvcard "$data_partition" /etc

  # remote settings
  update_boot "$geex_partition" remote "$CFG_REMOTE"
  update_boot "$geex_partition" receiver "$CFG_RECEIVER"
}

# include configurator common file
. /usr/share/configurator/common

# get i18n strings
get_i18n

# start dbus daemon if not yet started
ps | grep -q "[d]bus-daemon" || /etc/init.d/*dbus >/dev/null
# start hal daemon if not yet started
ps | grep -q "[h]ald-runner" || /etc/init.d/*hal >/dev/null
# start autmount daemon if not yet started
ps | grep -q "[a]utomountd" || /etc/init.d/*automountd >/dev/null

# read potential configurator file
test -f $CONFIG_FILE && . $CONFIG_FILE

# find geexbox installation (for updating grub, etc)
# TODO: should be possible to handle multiple GeeXboX installations, especially if one has an installation on hd and one on an usb stick or s.th.
geex_partition=""
for i in /mnt/*; do
  # ensure that this mount point is a disk
  echo "$i" | grep -qi disk || continue;

  test -d "$i/GEEXBOX" && geex_partition="$i" && break;
done

test -z "$geex_partition" && dialog --aspect 15 --backtitle "$MSG_CFG_TITLE" \
  --title "$MSG_ERROR" --msgbox "$MSG_SAVE_NO_GEEX_DISK" 0 0 && exit 1

dialog --aspect 15 --backtitle "$MSG_CFG_TITLE" --title "$MSG_MENU_SAVE" \
  --yesno "$MSG_SAVE_DESC_BEGIN ($geex_partition) $MSG_SAVE_DESC_END" 0 0 || exit 1

partitions=""
for i in /mnt/*; do
  # ensure that this mount point is a disk
  echo "$i" | grep -qi disk || continue;

  partitions="$partitions \"$i\""
  if [ -d "$i/GEEXBOX" ]; then
    partitions="$partitions \"GeeXboX installation\""
  else
    partitions="$partitions \"Other partition\""
  fi
done

test -z "$partitions" && dialog --aspect 15 --backtitle "$MSG_CFG_TITLE" \
  --title "$MSG_ERROR" --msgbox "$MSG_SAVE_NO_DISK" 0 0 && exit 1

echo dialog --aspect 15 --stdout --backtitle \"$MSG_CFG_TITLE\" \
  --title \"$MSG_MENU_SAVE\" --menu \"$MSG_SAVE_PARTITIONS\" 0 0 0 $partitions >/tmp/partselect
data_partition=`sh /tmp/partselect`
[ -z "$data_partition" ] && exit 1

geex_device=`get_device "$geex_partition"`
data_device=`get_device "$data_partition"`

remount rw "$geex_device" "$geex_partition"
if [ "$geex_device" != "$data_device" ]; then
  data_uuid=`blkid -o value -s UUID $data_device`
  remount rw "$data_device" "$data_partition"
fi
save_configs
remount ro "$geex_device" "$geex_partition"
[ "$geex_device" != "$data_device" ] && remount ro "$data_device" "$data_partition"

dialog --aspect 15 --backtitle "$MSG_CFG_TITLE" --title "$MSG_SUCCESS" \
  --msgbox "$MSG_SAVE_OK" 0 0
