#!/bin/sh

export HOME=/root
export ELM_THEME=/usr/share/elementary/themes/default.edj
[ -r /etc/locale ] && export LANG=`cat /etc/locale`

if [ -e /var/use_xorg ]; then
  export DISPLAY=:0.0
  
  # get the resolution X.org has actually started
  XRANDR_INFO=/tmp/xrandr
  while true; do
    xrandr -display :0.0 -q > $XRANDR_INFO
    [ -s $XRANDR_INFO ] && break
  done

  RES=`cat $XRANDR_INFO | grep "Screen 0" | sed 's/.* current \([0-9]*\) x \([0-9]*\),.*/\1x\2/'`
  RESX=`echo $RES | cut -f1 -dx`
  RESY=`echo $RES | cut -f2 -dx`
  ENNA_RES="${RESX}x${RESY}"
elif [ -e /dev/fb0 ]; then
  ENNA_RES=`/usr/sbin/fbset | sed -n 's/mode "\(.*\)-.*"/\1/p'`
fi

while true; do
  enna -g $ENNA_RES -f -c /etc/enna.cfg > /var/log/enna.log 2>&1
  if [ "$?" = 0 ]; then
    initctl emit shutdown REBOOT=no
    exit 0
  else
    # ensure no MPlayer instance is running if enna has previously crashed
    killall -9 mplayer
    exit 1
  fi
done
