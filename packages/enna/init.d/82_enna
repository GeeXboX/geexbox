#!/bin/sh
#
# configure and start Enna
#
# runlevels: geexbox, debug

kbd_set_map () {
  MAP="us"
  grep qwerty /proc/cmdline && MAP="us"
  grep qwertz /proc/cmdline && MAP="de"
  grep azerty /proc/cmdline && MAP="fr"
  setxkbmap -display ":0.0" $MAP
}

keymap=qwerty

. /etc/funcs

make_persistent file /etc/enna.cfg /var/data/config/enna.cfg
make_persistent file /etc/xine/config /var/data/config/xine-config
mkdir /root/.enna && make_persistent file /root/.enna/media.db /var/data/enna/media.db

ENNA_CMDLINE="-f -c /etc/enna.cfg"

if [ -x /usr/bin/enna ]; then
  echo "### Starting Enna ###"

  [ -r /etc/locale ] && export LANG=`cat /etc/locale`
  export ELM_THEME=/usr/share/elementary/themes/default.edj

  LOG=/var/log/enna.log

  if [ -f /var/use_xorg ]; then

    # special hack for vmware to enhance screen resolution
    grep -q 'VMWARE(0)' /var/log/Xorg.0.log && xrandr -s 1280x720 -d :0.0

    # get the resolution X.org has actually started
    XRANDR_INFO=/tmp/xrandr
    while true; do
      xrandr -display :0.0 -q > $XRANDR_INFO
      [ -s $XRANDR_INFO ] && break
    done

    # set correct keymap
    kbd_set_map

    RES=`cat $XRANDR_INFO | grep "Screen 0" | sed 's/.* current \([0-9]*\) x \([0-9]*\),.*/\1x\2/'`
    RESX=`echo $RES | cut -f1 -dx`
    RESY=`echo $RES | cut -f2 -dx`
    if [ -f /var/use_opengl ]; then
      sed_in_place /etc/enna.cfg 's/engine=software_x11/engine=opengl_x11/'
      export ELM_ENGINE=gl
    else
      export ELM_ENGINE=x11
    fi
    while true; do
      DISPLAY=:0.0 enna ${ENNA_CMDLINE} -g ${RESX}x${RESY} > $LOG 2>&1
      if [ "$?" = 0 ]; then
        if [ -x /usr/bin/vdrshutdown ]; then
          /usr/bin/vdrshutdown
          killall -q -TERM runvdr
        fi
        break
      fi
    done
  else
    if [ -e /dev/fb0 ]; then
      RES=`/usr/sbin/fbset | sed -n 's/mode "\(.*\)-.*"/\1/p'`
      ENNA_RES="-g $RES"
    fi
    sed_in_place /etc/enna.cfg 's%engine=.*%engine=fb%'
    sed_in_place /etc/enna.cfg 's%video_out=.*%video_out=fb%'
    export ELM_ENGINE=fb
    while true; do
      enna ${ENNA_CMDLINE} $ENNA_RES > $LOG 2>&1
      if [ "$?" = 0 ]; then
        if [ -x /usr/bin/vdrshutdown ]; then
          /usr/bin/vdrshutdown
          killall -q -TERM runvdr
        fi
        break
      fi
    done
  fi
fi

exit 0
