#!/bin/sh
#
# configure and start Enna
#
# runlevels: geexbox, debug

if [ -f /usr/bin/enna ]; then
  echo "### Starting Enna ###"
  mkdir -p /root/.enna
  cp -f /etc/enna.cfg /root/.enna/

  if [ -f /var/use_xorg ]; then
    # get the resolution X.org has actually started
    # it's not necessary the one requested in /etc/X11/X.cfg file
    XRANDR_INFO=/tmp/xrandr
    while true; do
      xrandr -display :0.0 -q > $XRANDR_INFO
      [ -s $XRANDR_INFO ] && break
    done

    RES=`cat $XRANDR_INFO | grep "Screen 0" | sed 's/.* current \([0-9]*\) x \([0-9]*\),.*/\1x\2/'`
    RESX=`echo $RES | cut -f1 -dx`
    RESY=`echo $RES | cut -f2 -dx`
    while true; do
      DISPLAY=:0.0 enna -f -g ${RESX}x${RESY}
    done
  else
    sed -i 's%engine=.*%engine=fb%' /root/.enna/enna.cfg
    while true; do
      enna -f
    done
  fi
fi

exit 0
