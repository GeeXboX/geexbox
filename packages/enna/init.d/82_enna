#!/bin/sh
#
# configure and start Enna
#
# runlevels: geexbox, debug

. /etc/funcs

make_persistent file /etc/enna.cfg /var/data/config/enna.cfg
make_persistent file /etc/xine/config /var/data/config/xine-config
mkdir /root/.enna && make_persistent file /root/.enna/valhalla_music.db /var/data/enna/valhalla_music.db

ENNA_CMDLINE="-f -c /etc/enna.cfg"

if [ -x /usr/bin/enna ]; then
  echo "### Starting Enna ###"

  [ -r /etc/locale ] && export LANG=`cat /etc/locale`
  export ELM_THEME=/usr/share/elementary/themes/default.edj

  if [ -f /var/use_xorg ]; then
    # get the resolution X.org has actually started
    # it's not necessary the one requested in /etc/X11/X.cfg file
    XRANDR_INFO=/tmp/xrandr
    while true; do
      xrandr -display :0.0 -q > $XRANDR_INFO
      [ -s $XRANDR_INFO ] && break
    done

    RES=`cat $XRANDR_INFO | grep "Screen 0" | sed 's/.* current \([0-9]*\) x \([0-9]*\),.*/\1x\2/'`
    RESX=`echo $RES | cut -f1 -dx`
    RESY=`echo $RES | cut -f2 -dx`
    export ELM_ENGINE=x11
    while true; do
      DISPLAY=:0.0 enna ${ENNA_CMDLINE} -g ${RESX}x${RESY}
      if [ "$?" = 0 ]; then
        if [ -x /usr/bin/vdrshutdown ]; then
          /usr/bin/vdrshutdown
          killall -q -TERM runvdr
        fi
        break
      fi
    done
  else
    if [ -e /dev/fb0 ]; then
      RES=`/usr/sbin/fbset | sed -n 's/mode "\(.*\)-.*"/\1/p'`
      ENNA_RES="-g $RES"
    fi
    sed -i 's%engine=.*%engine=fb%' /etc/enna.cfg
    export ELM_ENGINE=fb
    while true; do
      enna ${ENNA_CMDLINE} $ENNA_RES
      if [ "$?" = 0 ]; then
        if [ -x /usr/bin/vdrshutdown ]; then
          /usr/bin/vdrshutdown
          killall -q -TERM runvdr
        fi
        break
      fi
    done
  fi
fi

exit 0
