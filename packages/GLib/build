#!/bin/sh

. config/options

$SCRIPTS/build toolchain
[ "$TARGET_LIBC" = "uClibc" ] && $SCRIPTS/build libiconv

export ac_cv_func_posix_getpwuid_r=yes
export ac_cv_func_posix_getgrgid_r=yes
export glib_cv_stack_grows=no
export glib_cv_uscore=no

cd $BUILD/$1*

# build for host for gen-marshall tool
setup_toolchain host
mkdir -p objdir-host
cd objdir-host
../configure --enable-static --disable-shared
make
cp -f gobject/glib-genmarshal $ROOT/$TOOLCHAIN/bin
cd ..

# build for target
setup_toolchain target
mkdir -p objdir-target
cd objdir-target
EXTRA_OPTS=""
[ "$TARGET_LIBC" = "uClibc" ] && EXTRA_OPTS="--with-libiconv=gnu"
../configure --host=$TARGET_NAME \
            --build=$HOST_NAME \
            --prefix=$LIB_PREFIX \
            --enable-shared \
            --disable-static \
            --enable-debug=no \
            --disable-man \
            --disable-rebuilds \
            --disable-gtk-doc \
            $EXTRA_OPTS

make
strip_libs glib
strip_libs gobject
strip_libs gmodule
make install
