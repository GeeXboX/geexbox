#!/bin/sh

. config/options

require_glibc $1
require_cxx $1

$SCRIPTS/build toolchain
$SCRIPTS/unpack linux
$SCRIPTS/build jpeg
$SCRIPTS/build freetype
$SCRIPTS/build fontconfig
$SCRIPTS/build libiconv
$SCRIPTS/build gettext
$SCRIPTS/build nvram-wakeup

if [ "$VDR_PLUGINS" = all ]; then
  VDR_PLUGINS="`ls -d $PACKAGES/vdr-* | sed s/.*vdr-//`"
elif [ "$VDR_OUTPUT" != ffcard ]; then
  VDR_PLUGINS="$VDR_PLUGINS $VDR_OUTPUT"
fi

for plugin in $VDR_PLUGINS; do
  VDR_EXTENSIONS=
  if [ -r $PACKAGES/vdr-$plugin/config/vdr ]; then
    . $PACKAGES/vdr-$plugin/config/vdr
    for ext in $VDR_EXTENSIONS; do
      VDR_DEFINES="$VDR_DEFINES -D`echo $ext | tr a-z A-Z`"
    done
  fi
done

cd $BUILD/$1*
cat > Make.config <<EOF
VFAT=1
PLUGINLIBDIR=/usr/lib/vdr
VIDEODIR=/video
CONFDIR=/etc/vdr
LOCDIR=/usr/share/locale
INCLUDES += -I`ls -d ../freetype-*/include`
DEFINES  += -DLIEMIKUUTIO -DDOLBYINREC $VDR_DEFINES
EOF

make

# to build extra plugins
make include-dir

