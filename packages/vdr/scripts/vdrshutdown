#!/bin/sh

. /etc/nvram-wakeup

do_shutdown()
{
  sleep 5
  poweroff
}

do_reboot()
{
  sleep 5
  reboot
}

osdmsg()
{
  sleep 2
  echo "MESG $1" | nc localhost 2001
}

if [ -x /usr/bin/nvram-wakeup -a "$NVRAM_WAKEUP" = "yes" ]; then
  TIMER=$1
  if [ $REGULAR_DAYS -gt 0 ]; then
    REGULAR_TIMER=$((`date -d "$REGULAR_TIME" +%s` + $REGULAR_DAYS * 24 * 60 * 60))

    # when no vdr timer is set or vdr timer starts later than regular timer:
    if [ $TIMER -eq 0 ] || [ $TIMER -gt 0 -a $REGULAR_TIMER -lt $TIMER ] ; then
      TIMER=$REGULAR_TIMER
    fi
  fi
  if [ -r /etc/nvram-wakeup.conf ]; then
    /usr/bin/nvram-wakeup -C /etc/nvram-wakeup.conf -ls $TIMER 
  else
    /usr/bin/nvram-wakeup -ls $TIMER
  fi
  case $? in
    0) # everything is ok
       do_shutdown
       ;;
    1) # we need to reboot
       do_reboot
       ;;
    *) # something went wrong
       osdmsg "nvram-wakeup: cannot set time, shutdown aborted!"
       ;;
  esac
else
  do_shutdown
fi

