#!/bin/sh
#
# configure and launch VDR
#
# runlevels: geexbox, debug

if [ ! -f /var/dvbcard ]; then
  echo "No DVB card found, not starting VDR"
  exit 0
fi

echo "### Starting VDR ###"

PLUGINS=""
for file in /etc/vdr/plugins.d/*; do
  # plugins are enabled by default
  PLUGIN=""
  OPTIONS=""
  ENABLED=yes
  . $file
  [ "$ENABLED" = yes ] && PLUGINS="$PLUGINS -P'$PLUGIN $OPTIONS'"
  [ "$PLUGIN" = osdteletext ] && [ "$ENABLED" = yes ] && mkdir -p /tmp/vtx
done

# create /video if missing
for dir in /mnt/disk*; do
  if [ -d "$dir/video/." ]; then
    mount -o remount,rw "$dir"
    ln -sf "$dir/video/" /video
  fi
done
[ ! -e /video ] && mkdir /video

VDRCMD="vdr -g /tmp -s /usr/bin/vdrshutdown --vfat --no-kbd $PLUGINS > /tmp/vdr.out 2>&1"

# start VDR
if [ -x /usr/bin/mplayer ]; then
  runvdr "$VDRCMD" &
else
  runvdr "$VDRCMD"
fi

exit 0
