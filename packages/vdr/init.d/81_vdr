#!/bin/sh
#
# configure and launch VDR
#
# runlevels: geexbox, debug

. /etc/funcs

if [ ! -f /var/dvbcard -a ! -x /usr/bin/enna ]; then
  echo "No DVB card found, not starting VDR"
  exit 0
fi

echo "### Starting VDR ###"

make_persistent file /etc/wakeup /var/data/config/wakeup
make_persistent file /etc/vdr/channels.conf /var/data/vdr/channels.conf create
make_persistent file /etc/vdr/timers.conf /var/data/vdr/timers.conf create
make_persistent file /etc/vdr/setup.conf /var/data/vdr/setup.conf create
make_persistent dir /video /var/data/video create
make_persistent dir /etc/vdr/plugins/epgsearch /var/data/vdr/epgsearch create

PLUGINS=""
for file in /etc/vdr/plugins.d/*; do
  # plugins are enabled by default
  PLUGIN=""
  OPTIONS=""
  INITCMD=""
  ENABLED=yes
  . $file
  [ "$ENABLED" = yes ] && PLUGINS="$PLUGINS -P'$PLUGIN $OPTIONS'"
  [ -n "$INITCMD" ] && eval $INITCMD
done

VDRCMD="vdr -g /tmp -s /usr/bin/vdrshutdown --vfat --no-kbd $PLUGINS > /tmp/vdr.out 2>&1"

# start VDR
runvdr "$VDRCMD" &

exit 0
