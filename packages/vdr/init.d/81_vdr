#!/bin/sh
#
# configure and launch VDR
#
# runlevels: geexbox, debug

if [ ! -f /var/dvbcard ]; then
  echo "No DVB card found, not starting VDR"
  exit 0
fi

echo "### Starting VDR ###"

PLUGINS=""
for file in /etc/vdr/plugins.d/*; do
  # plugins are enabled by default
  PLUGIN=""
  OPTIONS=""
  ENABLED=yes
  . $file
  [ "$ENABLED" = yes ] && PLUGINS="$PLUGINS -P'$PLUGIN $OPTIONS'"
  [ "$PLUGIN" = osdteletext ] && [ "$ENABLED" = yes ] && mkdir -p /tmp/vtx
  [ "$PLUGIN" = softdevice ] && SOFTDEVICE=true
done

# create /video if missing
for dir in /mnt/disk*; do
  if [ -d "$dir/video/." ]; then
    mount -o remount,rw "$dir"
    ln -sf "$dir/video/" /video
  fi
done
[ ! -e /video ] && mkdir /video

# start X11 if needed
if [ "$SOFTDEVICE" = true -a -f /usr/bin/Xorg -a -f /var/use_xorg ]; then
  while [ ! -f /etc/X11/xorg.conf ]; do
    # ensure xorgconfig has finished creating the xorg.conf file
    sleep 1
  done
  # starts X.org with a black background
  Xorg vt$TTY -br -allowMouseOpenFail > /dev/null 2>&1 &
fi

VDRCMD="vdr -g /tmp -s /usr/bin/vdrshutdown --vfat --no-kbd $PLUGINS > /tmp/vdr.out 2>&1"

# start VDR
if [ -x /usr/bin/mplayer ]; then
  runvdr "$VDRCMD" &
else
  runvdr "$VDRCMD"
fi

exit 0
