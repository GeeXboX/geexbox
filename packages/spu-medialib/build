#!/bin/sh

. config/options

$SCRIPTS/build toolchain-spu
$SCRIPTS/build libspe2
$SCRIPTS/build speutils

TARGET_PREFIX="$ROOT/$TOOLCHAIN/bin/spu-"
export CC=${TARGET_PREFIX}gcc
export LD=${TARGET_PREFIX}ld
export AS=${TARGET_PREFIX}as
export AR=${TARGET_PREFIX}ar
export NM=${TARGET_PREFIX}nm
export RANLIB=${TARGET_PREFIX}ranlib
export OBJCOPY=${TARGET_PREFIX}objcopy
export STRIP=${TARGET_PREFIX}strip
export CFLAGS="-g -O2 -Wall -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -I$LIB_PREFIX/include -I$LIB_PREFIX/spu/include"

cd $BUILD/$1*/spu
./configure --build=$HOST_NAME \
            --host=$TARGET_NAME \
            --target=spu \
            --prefix=$LIB_PREFIX \
            --disable-shared \
            --enable-static
make

setup_toolchain target

cd ..
./configure --build=$HOST_NAME \
            --host=$TARGET_NAME \
            --target=$TARGET_NAME \
            --prefix=$LIB_PREFIX \
            --disable-shared \
            --enable-static
make
make install

# ugly ugly hack around spu code linking
$AR -qcs libspu-medialib.a generic/*.o src/*.o spu/src/*.eo.o
cp -f libspu-medialib.a "$LIB_PREFIX/lib"
