#!/bin/sh

. config/options

$SCRIPTS/install lzma
$SCRIPTS/build linux

export INSTALL=$BUILD/$1/mnt

rm -rf $INSTALL
mkdir -p $INSTALL
rm -f $BUILD/$1/$1 $BUILD/$1/$1.gz

mkdir $INSTALL/bin
mkdir $INSTALL/etc
mkdir $INSTALL/sbin
mkdir $INSTALL/usr
mkdir $INSTALL/usr/bin
mkdir $INSTALL/usr/sbin
mkdir $INSTALL/usr/lib
mkdir $INSTALL/dev
mkdir $INSTALL/mnt
mkdir $INSTALL/tmp
mkdir $INSTALL/root
mkdir $INSTALL/var
mkdir $INSTALL/var/run
mkdir $INSTALL/var/log
mkdir $INSTALL/var/lock
mkdir $INSTALL/proc
mkdir $INSTALL/sys

if [ $TARGET_ARCH = x86_64 -o $TARGET_ARCH = powerpc64 ]; then
  ln -s /lib $INSTALL/lib64
  ln -s lib $INSTALL/usr/lib64
fi

echo -n "" > $INSTALL/etc/mtab
echo -n "" > $INSTALL/etc/fstab
echo -n "" > $INSTALL/var/mnts

$SCRIPTS/install $TARGET_LIBC
$SCRIPTS/install gcc-final
$SCRIPTS/install busybox
$SCRIPTS/install udev
$SCRIPTS/install pcmciautils
$SCRIPTS/install zlib
$SCRIPTS/install linux modules-ramfs
if [ "$BOOTCHART" = yes ]; then
  $SCRIPTS/install acct
  cp $PACKAGES/$1/scripts/bootchartd $INSTALL/sbin
  sed -i "s/EXIT_PROC=.*/EXIT_PROC=\"$GUI\"/" $INSTALL/sbin/bootchartd
fi

cp $PACKAGES/$1/scripts/linuxrc $INSTALL
cp $PACKAGES/$1/scripts/console $INSTALL/sbin
cp $PACKAGES/$1/scripts/nosystem $INSTALL/sbin
cp $PACKAGES/$1/scripts/r[ow] $INSTALL/usr/bin

ln -s /bin/busybox $INSTALL/bin/sh
echo $TARGET_ARCH > $INSTALL/etc/arch

# Create a CPIO InitRamfs archive
cd $INSTALL
find . | cpio -o -H newc > $ROOT/$BUILD/$1/$1
cd -

if [ $TARGET_ARCH = i386 ]; then
  if [ "$COMPRESSION_METHOD" = lzma ]; then
    lzma e $BUILD/$1/$1 $BUILD/$1/$1.gz
  elif [ "$COMPRESSION_METHOD" = gzip ]; then
    gzip -9 $BUILD/$1/$1
  else
    mv $BUILD/$1/$1 $BUILD/$1/$1.gz
  fi
else
  gzip -9 $BUILD/$1/$1
fi
