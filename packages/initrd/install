#!/bin/sh

. config/options

test "$2" != installator && INSTALL="$INSTALL/boot"
mkdir -p $INSTALL
cp $BUILD/$1/$1.gz $INSTALL

if [ "$2" != generator ]; then
  $SCRIPTS/build bootsplash
  $SCRIPTS/build theme-$THEME

  splashdat=$BUILD/theme-$THEME/bootsplash-$RESOLUTION.dat
  [ ! -f $splashdat ] && echo "Theme $THEME does not support resolution $RESOLUTION" && exit 1

  cp $splashdat $ROOT/$INSTALL/bootsplash

  if [ $TARGET_ARCH = i386 ]; then
  lzma d $ROOT/$INSTALL/$1.gz $ROOT/$INSTALL/$1
  else
  gunzip $ROOT/$INSTALL/$1.gz
  fi

  # Append bootsplash to cpio archive
  cd $ROOT/$INSTALL
  echo "./bootsplash" | cpio -o -A -H newc -F $ROOT/$INSTALL/$1
  cd -

  if [ $TARGET_ARCH = i386 ]; then
  lzma e $ROOT/$INSTALL/$1 $ROOT/$INSTALL/$1.gz
  else
  gzip -9 $ROOT/$INSTALL/$1
  fi

  # Cleanup
  rm -f $ROOT/$INSTALL/bootsplash
  rm -f $ROOT/$INSTALL/$1
fi

exit 0
