#!/bin/sh

. config/options

test "$2" != installator && INSTALL="$INSTALL/boot"

mkdir -p $ROOT/$BUILD/$1
rm -f $BUILD/$1/$1 $BUILD/$1/$1.gz

# Create a CPIO InitRamfs archive
cd $ROOTFS
find . | cpio -o -H newc > $ROOT/$BUILD/$1/$1
cd -

GZIP="`which pigz`" || GZIP="`which gzip`"

if [ $TARGET_ARCH = i386 ]; then
  if [ "$COMPRESSION_METHOD" = lzma ]; then
    lzma -9 $BUILD/$1/$1 -S .gz
  elif [ "$COMPRESSION_METHOD" = gzip ]; then
    $GZIP -9 $BUILD/$1/$1
  else
    mv $BUILD/$1/$1 $BUILD/$1/$1.gz
  fi
elif [ $TARGET_ARCH = arm ]; then
  $GZIP -9 $BUILD/$1/$1
  mkimage -A arm -O linux -T ramdisk -C gzip -n "GeeXboX Ramdisk" -d $BUILD/$1/$1.gz $BUILD/$1/u$1.gz
  rm -f $BUILD/$1/$1.gz
else
  $GZIP -9 $BUILD/$1/$1
fi

mkdir -p $INSTALL
[ $TARGET_ARCH = arm ] && cp $BUILD/$1/u$1.gz $INSTALL || cp $BUILD/$1/$1.gz $INSTALL

exit 0
