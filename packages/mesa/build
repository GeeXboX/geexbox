#!/bin/sh

. config/options

$SCRIPTS/build libdrm
$SCRIPTS/build expat    # only headers are used

# mesa build is absolutely not thread-safe
export MAKEFLAGS=-j1

DRI_DRIVERS="mach64 r128 r200 r300 radeon tdfx trident"
if [ $TARGET_ARCH = i386 ]; then
  DRI_ARCH=x86
  DRI_DRIVERS="$DRI_DRIVERS i810 i915 i965 mga savage sis unichrome"
elif [ $TARGET_ARCH = x86_64 ]; then
  DRI_ARCH=x86-64
  DRI_DRIVERS="$DRI_DRIVERS i915 i965 mga savage unichrome"
elif [ $TARGET_ARCH = powerpc ]; then
  DRI_ARCH=ppc
fi

cd $BUILD/$1*
make realclean
make linux-dri-${DRI_ARCH} \
    CC=$CC \
    HOST_CC=$HOST_CC \
    OPT_FLAGS="$CFLAGS" \
    HOST_OPT_FLAGS="$HOST_CFLAGS" \
    ARCH_FLAGS= \
    X11_INCLUDES= \
    EXTRA_LIB_PATH= \
    SRC_DIRS="glx/x11 mesa" \
    PROGRAM_DIRS= \
    DRI_DIRS="$DRI_DRIVERS" \
    DRI_DRIVER_INSTALL_DIR="$XORG_PATH_DRI" \
    DRI_DRIVER_SEARCH_DIR="$XORG_PATH_DRI"

# strip libmesa
$STRIP src/mesa/libmesa.so*

# strip libglapi
$STRIP src/mesa/libglapi.so*

# strip DRI drivers
$STRIP lib*/*.so*

# copy GLX headers for xorg-server to build
cp -PR include/* $LIB_PREFIX/include
