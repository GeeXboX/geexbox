#!/bin/sh

. config/options

$SCRIPTS/build libdrm
$SCRIPTS/build expat    # only headers are used

# mesa build is absolutely not thread-safe
export MAKEFLAGS=-j1

if [ $TARGET_ARCH = i386 ]; then
  DRI_ARCH=x86
  DRI_DRIVERS="i810 i915 i965 mach64 mga r128 r200 r300 radeon savage sis tdfx unichrome"
elif [ $TARGET_ARCH = x86_64 ]; then
  DRI_ARCH=x86-64
  DRI_DRIVERS="i915 i965 mach64 mga r128 r200 r300 radeon savage tdfx unichrome"
elif [ $TARGET_ARCH = powerpc ]; then
  DRI_ARCH=ppc
  DRI_DRIVERS="mach64 r128 r200 r300 radeon tdfx"
fi

cd $BUILD/$1*
make realclean
make linux-dri-${DRI_ARCH} \
    CC=$CC \
    HOST_CC=$HOST_CC \
    X11_INCLUDES= \
    EXTRA_LIB_PATH= \
    SRC_DIRS="mesa" \
    PROGRAM_DIRS= \
    DRI_DIRS="$DRI_DRIVERS" \
    DRI_DRIVER_INSTALL_DIR="/usr/lib/dri" \
    DRI_DRIVER_SEARCH_DIR="/usr/lib/dri"

# strip DRI drivers (why are they sooooo big)
$STRIP lib/*.so*

# copy GLX headers for xorg-server to build
cp -PR include/* $LIB_PREFIX/include
