#!/bin/sh

. config/options

$SCRIPTS/build toolchain
$SCRIPTS/build lirc
$SCRIPTS/build zlib
$SCRIPTS/build alsa
$SCRIPTS/build freetype
$SCRIPTS/build fribidi
$SCRIPTS/build libiconv
$SCRIPTS/build libdvdcss
$SCRIPTS/build libdvdread
$SCRIPTS/build libdvdnav
$SCRIPTS/build libcdio
$SCRIPTS/build faad2

setup_toolchain --optimize target

set_option() {
  OPT="$1"
  CFG_LIST="$2"
  PKG="$3"
  [ "$OPT" = yes ] && CFG=enable || CFG=disable
  for CFG_NAME in $CFG_LIST; do
    EXTRA_CONFIG="$EXTRA_CONFIG --$CFG-$CFG_NAME"
  done
  [ $CFG = enable -a -n "$PKG" ] && $SCRIPTS/build $PKG
  return 0
}

EXTRA_LIBDIR="$LIB_PREFIX/lib"
EXTRA_INCDIR="$LIB_PREFIX/include"

set_option "$DXR3" "dxr3 ossaudio" "em8300"
set_option "$SDL" "sdl" "SDL"
set_option "$XORG" "xv xvmc x11 xf86keysym" "xorg-libs"

if [ "$LIVE555" = yes ]; then
  $SCRIPTS/build live
  EXTRA_CONFIG="$EXTRA_CONFIG --with-extraincdir=$LIB_PREFIX/live --with-extralibdir=$LIB_PREFIX/live"
else
  EXTRA_CONFIG="$EXTRA_CONFIG --disable-live"
fi

if [ "$GUI" = enna ]; then
  $SCRIPTS/build libpng
  EXTRA_CONFIG="$EXTRA_CONFIG --enable-png"
else
  EXTRA_CONFIG="$EXTRA_CONFIG --disable-png"
fi

if [ "$TARGET_ARCH" = i386 ]; then
  $SCRIPTS/build vesautils
  ARCH_CONFIG="--enable-win32dll \
               --enable-real \
               --realcodecsdir=/codecs \
               --win32codecsdir=/codecs \
               --disable-fbdev \
               --enable-vesa"
  VIDIX_DRV="cyberblade mach64 mga nvidia pm2 pm3 radeon rage128 unichrome sis"
  VIDIX_CONFIG="--enable-vidix"
elif [ "$TARGET_ARCH" = x86_64 ]; then
  ARCH_CONFIG="--disable-win32dll \
               --disable-real \
               --disable-fbdev \
               --disable-vesa"
  VIDIX_CONFIG="--disable-vidix"
else
  ARCH_CONFIG="--disable-win32dll \
               --disable-real \
               --enable-fbdev \
               --disable-vesa"
  VIDIX_DRV="mach64 mga nvidia pm2 pm3 radeon rage128"
  VIDIX_CONFIG="--enable-vidix" 
fi

if [ "$DEBUG" = yes ]; then
  DEBUG_CONFIG="--enable-debug=3 \
                --enable-crash-debug"
else
  DEBUG_CONFIG="--disable-debug"
fi

CFLAGS="$CFLAGS -ffast-math -DFIXED_POINT"

cd $BUILD/$1*
./configure --prefix=/usr \
            --confdir=/etc/mplayer \
            --with-extralibdir="$EXTRA_LIBDIR" \
            --with-extraincdir="$EXTRA_INCDIR" \
            --enable-radio \
            --enable-radio-v4l2 \
            $ARCH_CONFIG \
            $EXTRA_CONFIG \
            --disable-mencoder \
            --disable-gui \
            --enable-largefiles \
            --disable-linux-devfs \
            --disable-termcap \
            --disable-langinfo \
            --enable-lirc \
            --disable-lircc \
            --enable-joystick \
            --disable-apple-remote \
            --enable-apple-ir \
            --enable-tv \
            --disable-tv-v4l1 \
            --enable-tv-v4l2 \
            --enable-tv-teletext \
            --disable-tv-bsdbt848 \
            --enable-rtc \
            --enable-network \
            --disable-winsock2_h \
            --disable-ivtv \
            --enable-v4l2 \
            --disable-smb \
            --disable-nemesi \
            --enable-dvdread \
            --disable-dvdread-internal \
            --with-dvdread-config="$LIB_PREFIX/bin/dvdread-config" \
            --disable-libdvdcss-internal \
            --enable-dvdnav \
            --with-dvdnav-config="$LIB_PREFIX/bin/dvdnav-config" \
            --disable-cdparanoia \
            --enable-freetype \
            --with-freetype-config="$LIB_PREFIX/bin/freetype-config" \
            --disable-fontconfig \
            --enable-fribidi \
            --with-fribidi-config="$LIB_PREFIX/bin/fribidi-config" \
            --disable-unrarexec \
            --enable-menu \
            --disable-sortsub \
            --disable-enca \
            --disable-macosx \
            --disable-inet6 \
            --disable-gethostbyname2 \
            --enable-ftp \
            --disable-vstream \
            --enable-ass \
            --disable-gif \
            --disable-jpeg \
            --disable-liblzo \
            --disable-xanim \
            --disable-xvid \
            --disable-x264 \
            --disable-demuxer=matroska \
            --disable-libavcodec_so \
            --disable-libavformat_so \
            --disable-libpostproc_so \
            --disable-speex \
            --disable-tremor-internal \
            --disable-tremor-low \
            --disable-tremor \
            --disable-libvorbis \
            --disable-theora \
            --enable-faad \
            --disable-faad-internal \
            --disable-faac \
            --disable-ladspa \
            --disable-libdv \
            --disable-mad \
            --disable-toolame \
            --disable-xmms \
            --enable-mp3lib \
            --enable-liba52 \
            --disable-libmpeg2 \
            --disable-musepack \
            $VIDIX_CONFIG \
            --with-vidix-drivers="$VIDIX_DRV" \
            --disable-vidix-pcidb \
            --disable-gl \
            --disable-dga1 \
            --disable-dga2 \
            --disable-svga \
            --disable-aa \
            --disable-caca \
            --disable-ggi \
            --disable-ggiwmh \
            --disable-directx \
            --disable-dxr2 \
            --disable-dvb \
            --enable-dvbhead \
            --disable-mga \
            --disable-xmga \
            --disable-vdpau \
            --disable-vm \
            --disable-xinerama \
            --disable-mlib \
            --disable-3dfx \
            --disable-tdfxfb \
            --disable-zr \
            --disable-bl \
            --disable-tdfxvid \
            --disable-tga \
            --disable-pnm \
            --disable-yuv4mpeg \
            --disable-wii \
            --disable-md5sum \
            --disable-arts \
            --disable-esd \
            --disable-pulse \
            --disable-jack \
            --disable-openal \
            --enable-alsa \
            --disable-sgiaudio \
            --disable-sunaudio \
            --disable-nas \
            --disable-win32waveout \
            --disable-select \
            --enable-runtime-cpudetection \
            --enable-cross-compile \
            --target="$TARGET_ARCH-linux" \
            --as=$AS \
            --cc=$CC \
            --host-cc=$HOST_CC \
            --language=en \
            --disable-shm \
            --disable-dynamic-plugins \
            $DEBUG_CONFIG
make
