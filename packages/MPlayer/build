#!/bin/sh

. config/options

$SCRIPTS/build toolchain
$SCRIPTS/build lirc
$SCRIPTS/build libogg
$SCRIPTS/build libvorbis
$SCRIPTS/build libtheora
$SCRIPTS/build libdts
$SCRIPTS/build libmpcdec
$SCRIPTS/build cdparanoia
$SCRIPTS/build zlib
$SCRIPTS/build alsa
$SCRIPTS/build freetype
$SCRIPTS/build fribidi
$SCRIPTS/build iconv-base

setup_toolchain --optimize target

if [ "$DXR3" = "yes" ]; then
  $SCRIPTS/build em8300
  DXR3_CONFIG="--enable-dxr3 --enable-ossaudio"
else
  DXR3_CONFIG="--disable-dxr3 --disable-ossaudio"
fi

if [ "$LIVE555" = "yes" ]; then
  $SCRIPTS/build live
  LIVE555_CONFIG="--enable-live --with-livelibdir=$LIB_PREFIX/live"
else
  LIVE555_CONFIG="--disable-live"
fi

if [ "$ENCODERS" = "yes" ]; then
  ENCODERS_CONFIG="--enable-mencoder --enable-additional-filters"
else
  ENCODERS_CONFIG="--disable-mencoder --disable-additional-filters"
fi

if [ "$TARGET_ARCH" = i386 ]; then
  $SCRIPTS/build vesautils
  ARCH_CONFIG="--enable-win32 \
               --enable-dshow \
               --enable-real \
               --with-reallibdir=/codecs \
               --with-win32libdir=/codecs \
               --disable-fbdev \
               --enable-vesa"
else
  ARCH_CONFIG="--disable-win32 \
               --disable-dshow \
               --disable-real \
               --enable-fbdev \
               --disable-vesa"
fi

CFLAGS="$CFLAGS -ffast-math -DFIXED_POINT -D__USE_EXTERN_INLINES"

cd $BUILD/$1*
./configure --prefix=/usr \
            --confdir=/etc/mplayer \
            --with-extralibdir="$LIB_PREFIX/lib" \
            --with-extraincdir="$LIB_PREFIX/include" \
            $ARCH_CONFIG \
            $DXR3_CONFIG \
            $LIVE555_CONFIG \
            $ENCODERS_CONFIG \
            --disable-gui \
            --enable-largefiles \
            --disable-linux-devfs \
            --disable-termcap \
            --disable-langinfo \
            --enable-lirc \
            --disable-lircc \
            --enable-joystick \
            --disable-xf86keysym \
            --enable-tv \
            --disable-tv-v4l \
            --enable-tv-v4l2 \
            --disable-tv-bsdbt848 \
            --enable-rtc \
            --enable-network \
            --disable-winsock2 \
            --disable-smb \
            --disable-dvdread \
            --enable-mpdvdkit \
            --enable-dvdnav \
            --disable-dvdnav-trace \
            --enable-cdparanoia \
            --enable-freetype \
            --with-freetype-config="$LIB_PREFIX/bin/freetype-config" \
            --disable-fontconfig \
            --enable-fribidi \
            --with-fribidi-config="$LIB_PREFIX/bin/fribidi-config" \
            --enable-unrarlib \
            --enable-menu \
            --disable-sortsub \
            --disable-enca \
            --disable-macosx \
            --disable-inet6 \
            --disable-gethostbyname2 \
            --disable-ftp \
            --disable-vstream \
            --disable-gif \
            --disable-png \
            --disable-jpeg \
            --disable-libcdio \
            --disable-liblzo \
            --disable-qtx \
            --disable-xanim \
            --disable-xvid \
            --disable-x264 \
            --disable-divx4linux \
            --disable-opendivx \
            --enable-libavcodec \
            --disable-libavformat \
            --enable-libpostproc \
            --disable-libavcodec_so \
            --disable-libavformat_so \
            --disable-libpostproc_so \
            --disable-libfame \
            --enable-vorbis \
            --disable-speex \
            --disable-internal-tremor \
            --disable-tremor-low \
            --disable-external-tremor \
            --enable-theora \
            --disable-external-faad \
            --enable-internal-faad \
            --disable-faac \
            --disable-ladspa \
            --disable-libdv \
            --disable-mad \
            --disable-toolame \
            --disable-xmms \
            --enable-mp3lib \
            --enable-liba52 \
            --enable-libdts \
            --disable-libmpeg2 \
            --enable-musepack \
            --disable-amr_nb \
            --disable-amr_nb-fixed \
            --disable-amr_wb \
            --enable-internal-vidix \
            --disable-external-vidix \
            --disable-gl \
            --disable-dga \
            --disable-svga \
            --disable-sdl \
            --disable-aa \
            --disable-caca \
            --disable-ggi \
            --disable-ggiwmh \
            --disable-directx \
            --disable-dxr2 \
            --disable-dvb \
            --enable-dvbhead \
            --disable-mga \
            --disable-xmga \
            --disable-xv \
            --disable-xvmc \
            --disable-vm \
            --disable-xinerama \
            --disable-x11 \
            --disable-mlib \
            --disable-3dfx \
            --disable-tdfxfb \
            --disable-directfb \
            --disable-zr \
            --disable-bl \
            --disable-tdfxvid \
            --disable-tga \
            --disable-pnm \
            --disable-md5sum \
            --disable-arts \
            --disable-esd \
            --disable-polyp \
            --disable-jack \
            --disable-openal \
            --enable-alsa \
            --disable-sgiaudio \
            --disable-sunaudio \
            --disable-nas \
            --disable-win32waveout \
            --disable-select \
            --enable-runtime-cpudetection \
            --enable-cross-compile \
            --target="$TARGET_ARCH-linux" \
            --as=$AS \
            --cc=$CC \
            --host-cc=$HOST_CC \
            --language=en \
            --disable-shm \
            --disable-dynamic-plugins
sed -i s/-lnsl// config.mak
sed -i 's/.*HAVE_LRINTF.*/#define HAVE_LRINTF 1/' config.h
sed -i 's/.*HAVE_ROUND.*/#undef HAVE_ROUND/' config.h
[ $DEBUG = "yes" ] && sed -i 's/.*MP_DEBUG.*/#define MP_DEBUG 1/' config.h
make
$STRIP libdha/libdha.so vidix/drivers/*.so
