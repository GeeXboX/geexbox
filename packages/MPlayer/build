#!/bin/sh

. config/options

$SCRIPTS/build toolchain
$SCRIPTS/build zlib
$SCRIPTS/build alsa
$SCRIPTS/build freetype
$SCRIPTS/build fribidi
$SCRIPTS/build libiconv
$SCRIPTS/build libcdio
$SCRIPTS/build faad2
$SCRIPTS/build ffmpeg

setup_toolchain --optimize target

set_option() {
  OPT="$1"
  CFG_LIST="$2"
  PKG="$3"
  [ "$OPT" = yes ] && CFG=enable || CFG=disable
  for CFG_NAME in $CFG_LIST; do
    EXTRA_CONFIG="$EXTRA_CONFIG --$CFG-$CFG_NAME"
  done
  [ $CFG = enable -a -n "$PKG" ] && $SCRIPTS/build $PKG
  return 0
}

EXTRA_LIBDIR="-L$LIB_PREFIX/lib"
EXTRA_INCDIR="-I$LIB_PREFIX/include"
EXTRA_LIBS="-lavcodec -lavformat -lavutil -lpostproc -lswscale"

set_option "$SDL" "sdl" "SDL"
set_option "$XORG" "xv xvmc x11 xf86keysym" "xorg-libs"
set_option "$UNRAR" "unrarexec" "unrar"
set_option "$VDPAU" "vdpau" "xf86-video-nvidia"

if [ "$LIVE555" = yes ]; then
  $SCRIPTS/build live
  EXTRA_LIBDIR="$EXTRA_LIBDIR -L$LIB_PREFIX/live"
  EXTRA_INCDIR="$EXTRA_INCDIR -I$LIB_PREFIX/live"
else
  EXTRA_CONFIG="$EXTRA_CONFIG --disable-live"
fi

if [ "$GUI" = enna ]; then
  $SCRIPTS/build libpng
  EXTRA_CONFIG="$EXTRA_CONFIG --enable-png --disable-lirc --disable-dvbhead --disable-dvdread --disable-dvdnav --disable-tv --disable-tv-v4l2 --disable-tv-teletext --disable-radio --disable-radio-v4l2 --disable-v4l2"
else
  $SCRIPTS/build lirc
  $SCRIPTS/build libdvdcss
  $SCRIPTS/build libdvdread
  $SCRIPTS/build libdvdnav
  EXTRA_CONFIG="$EXTRA_CONFIG --disable-png --enable-lirc --enable-dvbhead --enable-dvdread --enable-dvdnav --enable-tv --enable-tv-v4l2 --enable-tv-teletext --enable-radio --enable-radio-v4l2 --enable-v4l2"
fi

if [ "$VDPAU" = yes ]; then
  EXTRA_LIBS="$EXTRA_LIBS -lvdpau"
fi

if [ "$TARGET_ARCH" = i386 ]; then
  $SCRIPTS/build vesautils
  ARCH_CONFIG="--enable-win32dll \
               --enable-real \
               --realcodecsdir=/codecs \
               --win32codecsdir=/codecs \
               --disable-fbdev \
               --enable-vesa"
  VIDIX_DRV="cyberblade mach64 mga nvidia pm2 pm3 radeon rage128 unichrome sis"
  VIDIX_CONFIG="--enable-vidix"
elif [ "$TARGET_ARCH" = x86_64 ]; then
  ARCH_CONFIG="--disable-win32dll \
               --disable-real \
               --disable-fbdev \
               --disable-vesa"
  VIDIX_CONFIG="--disable-vidix"
elif [ "$TARGET_PLATFORM" = ps3 ]; then
  $SCRIPTS/build spu-medialib
  ARCH_CONFIG="--disable-win32dll \
               --disable-real \
               --enable-fbdev \
               --enable-ps3 \
               --disable-vesa \
               --enable-altivec \
               --disable-runtime-cpudetection"
  VIDIX_CONFIG="--disable-vidix"
  CFLAGS="$CFLAGS -maltivec -mabi=altivec"
  EXTRA_LIBS="$EXTRA_LIBS -lspu-medialib -lspe2 -lspeutils"
else
  ARCH_CONFIG="--disable-win32dll \
               --disable-real \
               --enable-fbdev \
               --disable-vesa"
  VIDIX_DRV="mach64 mga nvidia pm2 pm3 radeon rage128"
  VIDIX_CONFIG="--enable-vidix" 
fi

if [ "$DEBUG" = yes ]; then
  DEBUG_CONFIG="--enable-debug=3 \
                --enable-crash-debug"
else
  DEBUG_CONFIG="--disable-debug"
fi

CFLAGS="$CFLAGS -ffast-math -DFIXED_POINT"

cd $BUILD/$1*
rm -rf libavcodec # ensure we check for headers in external ffmpeg
./configure --prefix=/usr \
            --confdir=/etc/mplayer \
            --extra-ldflags="$EXTRA_LIBDIR" \
            --extra-cflags="$EXTRA_INCDIR" \
            $ARCH_CONFIG \
            $EXTRA_CONFIG \
            --disable-mencoder \
            --disable-gui \
            --enable-largefiles \
            --disable-linux-devfs \
            --disable-termcap \
            --disable-langinfo \
            --disable-lircc \
            --enable-joystick \
            --disable-apple-remote \
            --disable-apple-ir \
            --disable-tv-v4l1 \
            --disable-tv-bsdbt848 \
            --enable-rtc \
            --enable-network \
            --disable-winsock2_h \
            --disable-ivtv \
            --disable-smb \
            --disable-nemesi \
            --disable-dvdread-internal \
            --with-dvdread-config="$LIB_PREFIX/bin/dvdread-config" \
            --disable-libdvdcss-internal \
            --with-dvdnav-config="$LIB_PREFIX/bin/dvdnav-config" \
            --disable-cdparanoia \
            --enable-freetype \
            --with-freetype-config="$LIB_PREFIX/bin/freetype-config" \
            --disable-fontconfig \
            --enable-fribidi \
            --with-fribidi-config="$LIB_PREFIX/bin/fribidi-config" \
            --enable-menu \
            --disable-sortsub \
            --disable-enca \
            --disable-quartz \
            --disable-inet6 \
            --disable-gethostbyname2 \
            --enable-ftp \
            --disable-vstream \
            --enable-ass \
            --disable-gif \
            --disable-jpeg \
            --disable-liblzo \
            --disable-xanim \
            --disable-xvid \
            --disable-x264 \
            --disable-demuxer=matroska \
            --enable-libavcodec_so \
            --enable-libavformat_so \
            --enable-libavutil_so \
            --enable-libpostproc_so \
            --enable-libswscale_so \
            --disable-libavcodec_a \
            --disable-libavformat_a \
            --disable-libavutil_a \
            --disable-libpostproc_a \
            --disable-libswscale_a \
            --disable-speex \
            --disable-tremor-internal \
            --disable-tremor-low \
            --disable-tremor \
            --disable-libvorbis \
            --disable-theora \
            --enable-faad \
            --disable-faad-internal \
            --disable-faac \
            --disable-ladspa \
            --disable-libdv \
            --disable-mad \
            --disable-toolame \
            --disable-xmms \
            --enable-mp3lib \
            --disable-liba52 \
            --disable-liba52-internal \
            --disable-libmpeg2 \
            --disable-musepack \
            $VIDIX_CONFIG \
            --with-vidix-drivers="$VIDIX_DRV" \
            --disable-vidix-pcidb \
            --disable-gl \
            --disable-dga1 \
            --disable-dga2 \
            --disable-svga \
            --disable-aa \
            --disable-caca \
            --disable-ggi \
            --disable-ggiwmh \
            --disable-directx \
            --disable-dxr2 \
            --disable-dvb \
            --disable-mga \
            --disable-xmga \
            --disable-vm \
            --disable-xinerama \
            --disable-mlib \
            --disable-3dfx \
            --disable-tdfxfb \
            --disable-zr \
            --disable-bl \
            --disable-tdfxvid \
            --disable-tga \
            --disable-pnm \
            --disable-yuv4mpeg \
            --disable-wii \
            --disable-md5sum \
            --disable-arts \
            --disable-esd \
            --disable-pulse \
            --disable-jack \
            --disable-openal \
            --enable-alsa \
            --disable-sgiaudio \
            --disable-sunaudio \
            --disable-nas \
            --disable-win32waveout \
            --disable-select \
            --enable-runtime-cpudetection \
            --enable-cross-compile \
            --target="$TARGET_ARCH-linux" \
            --as=$AS \
            --cc=$CC \
            --host-cc=$HOST_CC \
            --language=en \
            --disable-shm \
            --disable-dynamic-plugins \
            --extra-libs="$EXTRA_LIBS" \
            $DEBUG_CONFIG
make
