#!/bin/sh

. config/options

$SCRIPTS/build zlib
[ "$TARGET_LIBC" = "uClibc" ] && $SCRIPTS/build libiconv
$SCRIPTS/build ffmpeg
$SCRIPTS/build freetype
$SCRIPTS/build alsa-lib

fix_dirs () {
  sed -i "s%.*${1}.*%#define ${1} \"/usr/${2}\"%" include/configure.h
}

if [ "$DEBUG" = yes ]; then
  DEBUG_CONFIG="--enable-debug"
else
  DEBUG_CONFIG="--disable-debug"
fi

if [ "$XORG" = yes ]; then
  XORG_CONFIG="--with-x --enable-opengl"
else
  XORG_CONFIG="--without-x --disable-opengl"
fi

if [ "$CONSOLE" = yes ]; then
  CONSOLE_CONFIG="--enable-fb"
else
  CONSOLE_CONFIG="--disable-fb"
fi

if [ "$SDL" = yes ]; then
  SDL_CONFIG="--with-sdl"
else
  SDL_CONFIG="--without-sdl"
fi

if [ "$VDR" = yes ]; then
  VDR_CONFIG="--enable-vdr"
else
  VDR_CONFIG="--disable-vdr"
fi

if [ "$VDPAU" = yes ]; then
  $SCRIPTS/build libvdpau
  VDPAU_CONFIG="--enable-vdpau"
  LDFLAGS="$LDFLAGS -lvdpau"
else
  VDPAU_CONFIG="--disable-vdpau"
fi

cd $BUILD/$1*
export LDFLAGS="$LDFLAGS -lm -ldl -lavcodec -lavformat -lavutil -lpostproc -lswscale"
[ "$TARGET_LIBC" = "uClibc" ] && export LDFLAGS="$LDFLAGS -lintl -liconv"
export CPP=${TARGET_PREFIX}cpp
./configure --host=$TARGET_NAME \
            --build=$HOST_NAME \
            --prefix=$LIB_PREFIX \
            --exec-prefix=/usr \
            --libdir=$LIB_PREFIX/lib \
            --enable-shared \
            --disable-static \
            --disable-dependency-tracking \
            --disable-ipv6 \
            --disable-coreaudio \
            --disable-irixal \
            --disable-oss \
            --disable-sunaudio \
            --disable-aalib \
            --disable-dha-kmod \
            --disable-directfb \
            --disable-dxr3 \
            --disable-macosx-video \
            --disable-glu \
            --disable-vidix \
            --disable-xinerama \
            --disable-static-xv \
            --disable-xvmc \
            --disable-dvb \
            --disable-gnomevfs \
            --disable-samba \
            --disable-v4l \
            --disable-vcd \
            --disable-a52dec \
            --disable-asf \
            --disable-nosefart \
            --disable-faad \
            --disable-gdkpixbuf \
            --disable-dts \
            --disable-libmpeg2new \
            --enable-mad \
            --disable-modplug \
            --disable-musepack \
            --disable-mlib \
            --disable-mlib-lazyload \
            --disable-mng \
            --disable-real-codecs \
            --disable-w32dll \
            --with-freetype \
            --without-fontconfig \
            --with-alsa \
            --without-esound \
            --without-fusionsound \
            --without-jack \
            --without-pulseaudio \
            --without-caca \
            --without-dxheaders \
            --without-libstk \
            --without-external-dvdnav \
            --without-imagemagick \
            --without-libflac \
            --without-speex \
            --without-theora \
            --without-vorbis \
            --without-xcb \
            --without-wavpack \
            $DEBUG_CONFIG \
            $XORG_CONFIG \
            $CONSOLE_CONFIG \
            $SDL_CONFIG \
            $VDR_CONFIG
fix_dirs XINE_FONTDIR    share/xine/libxine1/fonts
fix_dirs XINE_LOCALEDIR  share/locale
fix_dirs XINE_PLUGINDIR  lib/xine/plugins/2.0
fix_dirs XINE_PLUGINROOT lib/xine/plugins/2
make
strip_libs src
make install \
  bindir=$LIB_PREFIX/bin \
  libdir=$LIB_PREFIX/lib \
  datarootdir=$LIB_PREFIX/share \
  sysconfdir=$SYSROOT_PREFIX/etc \
  xinelibdir=$LIB_PREFIX/lib/xine
